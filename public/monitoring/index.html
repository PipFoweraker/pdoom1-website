<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring - p(Doom)1</title>
    <link rel="canonical" href="https://pdoom1.com/monitoring/" />
    <meta name="description" content="System health monitoring and deployment status for p(Doom)1 website and infrastructure." />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --accent-primary: #00ff41;
            --accent-secondary: #ff6b35;
            --accent-danger: #ff4444;
            --accent-warning: #ffaa00;
            --border-color: #444444;
            --radius-lg: 10px;
            --radius-md: 6px;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-primary);
            padding: 1rem;
        }
        
        .back-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: bold;
        }
        
        h1 {
            color: var(--accent-primary);
            text-align: center;
            margin: 2rem 0;
            font-size: 2.5rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }
        
        .status-card.healthy {
            border-left: 4px solid var(--accent-primary);
        }
        
        .status-card.warning {
            border-left: 4px solid var(--accent-warning);
        }
        
        .status-card.error {
            border-left: 4px solid var(--accent-danger);
        }
        
        .status-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .status-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: auto;
        }
        
        .status-indicator.healthy { background: var(--accent-primary); }
        .status-indicator.warning { background: var(--accent-warning); }
        .status-indicator.error { background: var(--accent-danger); }
        .status-indicator.unknown { background: var(--text-muted); }
        
        .status-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .metrics-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .metrics-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .metrics-list li:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--text-secondary);
        }
        
        .metric-value {
            color: var(--accent-primary);
            font-weight: bold;
        }
        
        .recent-checks {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .check-item:last-child {
            border-bottom: none;
        }
        
        .check-name {
            color: var(--text-primary);
        }
        
        .check-status {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .check-status.pass {
            background: rgba(0, 255, 65, 0.2);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }
        
        .check-status.fail {
            background: rgba(255, 68, 68, 0.2);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        
        .check-status.warn {
            background: rgba(255, 170, 0, 0.2);
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
        }
        
        .refresh-controls {
            text-align: center;
            margin: 2rem 0;
        }
        
        .refresh-btn {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: rgba(0, 255, 65, 0.8);
        }
        
        .refresh-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        
        .last-updated {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="/" class="back-link">‚Üê Back to Home</a>
    </header>
    
    <div class="container">
        <h1>System Monitoring</h1>

        <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">
            Admin & Operations Dashboard - Infrastructure monitoring and automation status
        </p>

        <div class="status-grid">
            <div class="status-card" id="website-status">
                <div class="status-header">
                    <div class="status-title">Website Status</div>
                    <div class="status-indicator unknown"></div>
                </div>
                <div class="status-details">
                    <ul class="metrics-list">
                        <li><span class="metric-label">Status</span><span class="metric-value" id="site-status">Checking...</span></li>
                        <li><span class="metric-label">Response Time</span><span class="metric-value" id="response-time">--</span></li>
                        <li><span class="metric-label">Last Check</span><span class="metric-value" id="last-check">--</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="status-card" id="deployment-status">
                <div class="status-header">
                    <div class="status-title">Deployment Status</div>
                    <div class="status-indicator unknown"></div>
                </div>
                <div class="status-details">
                    <ul class="metrics-list">
                        <li><span class="metric-label">Last Deploy</span><span class="metric-value" id="last-deploy">--</span></li>
                        <li><span class="metric-label">Version</span><span class="metric-value" id="current-version">--</span></li>
                        <li><span class="metric-label">Health Score</span><span class="metric-value" id="health-score">--</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="status-card" id="data-status">
                <div class="status-header">
                    <div class="status-title">Data Freshness</div>
                    <div class="status-indicator unknown"></div>
                </div>
                <div class="status-details">
                    <ul class="metrics-list">
                        <li><span class="metric-label">Version Data</span><span class="metric-value" id="version-age">--</span></li>
                        <li><span class="metric-label">Game Stats</span><span class="metric-value" id="stats-age">--</span></li>
                        <li><span class="metric-label">Next Update</span><span class="metric-value" id="next-update">--</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="status-card" id="github-status">
                <div class="status-header">
                    <div class="status-title">GitHub Integration</div>
                    <div class="status-indicator unknown"></div>
                </div>
                <div class="status-details">
                    <ul class="metrics-list">
                        <li><span class="metric-label">API Status</span><span class="metric-value" id="github-api">--</span></li>
                        <li><span class="metric-label">Open Issues</span><span class="metric-value" id="open-issues">--</span></li>
                        <li><span class="metric-label">Last Release</span><span class="metric-value" id="last-release">--</span></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Automation Status Section -->
        <div class="recent-checks" style="margin-top: 3rem;">
            <h2>ü§ñ Automation Status</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                GitHub Actions automated tasks - scheduled jobs running infrastructure updates
            </p>
            <div id="automation-status">
                Loading automation status...
            </div>
        </div>

        <!-- Weekly League Management Section -->
        <div class="recent-checks">
            <h2>üèÜ Weekly League Management</h2>
            <div id="league-status">
                Loading league status...
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button class="refresh-btn" onclick="triggerLeagueRollover()" id="league-rollover-btn">
                    Manually Trigger League Rollover
                </button>
            </div>
        </div>

        <div class="recent-checks">
            <h2>Recent Health Checks</h2>
            <div id="recent-checks-list">
                Loading health check history...
            </div>
        </div>
        
        <div class="refresh-controls">
            <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">
                Refresh All Data
            </button>
        </div>
        
        <div class="last-updated" id="last-updated">
            Last updated: Loading...
        </div>
    </div>
    
    <script>
        let refreshing = false;
        
        async function loadHealthData() {
            try {
                const response = await fetch('/data/health-check.json', { cache: 'no-store' });
                const data = await response.json();
                return data;
            } catch (error) {
                console.warn('Could not load health data:', error);
                return null;
            }
        }
        
        async function loadVersionData() {
            try {
                const response = await fetch('/data/version.json', { cache: 'no-store' });
                const data = await response.json();
                return data;
            } catch (error) {
                console.warn('Could not load version data:', error);
                return null;
            }
        }
        
        async function loadDeploymentData() {
            try {
                const response = await fetch('/data/deployment-verification.json', { cache: 'no-store' });
                const data = await response.json();
                return data;
            } catch (error) {
                console.warn('Could not load deployment data:', error);
                return null;
            }
        }
        
        function updateStatusCard(cardId, status, details = {}) {
            const card = document.getElementById(cardId);
            const indicator = card.querySelector('.status-indicator');
            
            // Update indicator
            indicator.className = `status-indicator ${status}`;
            
            // Update card styling
            card.className = `status-card ${status}`;
            
            // Update details if provided
            Object.entries(details).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = value;
                }
            });
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '--';
            return new Date(timestamp).toLocaleString();
        }
        
        function formatAge(timestamp) {
            if (!timestamp) return '--';
            const age = (new Date() - new Date(timestamp)) / 1000 / 60; // minutes
            if (age < 60) return `${Math.floor(age)}m ago`;
            if (age < 1440) return `${Math.floor(age / 60)}h ago`;
            return `${Math.floor(age / 1440)}d ago`;
        }
        
        async function updateWebsiteStatus() {
            try {
                const start = Date.now();
                const response = await fetch(window.location.origin, { cache: 'no-store' });
                const responseTime = Date.now() - start;
                
                if (response.ok) {
                    updateStatusCard('website-status', 'healthy', {
                        'site-status': 'Online',
                        'response-time': `${responseTime}ms`,
                        'last-check': 'Just now'
                    });
                } else {
                    updateStatusCard('website-status', 'error', {
                        'site-status': `Error ${response.status}`,
                        'response-time': `${responseTime}ms`,
                        'last-check': 'Just now'
                    });
                }
            } catch (error) {
                updateStatusCard('website-status', 'error', {
                    'site-status': 'Offline',
                    'response-time': 'Timeout',
                    'last-check': 'Just now'
                });
            }
        }
        
        async function updateDeploymentStatus() {
            const deploymentData = await loadDeploymentData();
            const versionData = await loadVersionData();
            
            if (deploymentData && versionData) {
                const status = deploymentData.deployment_approved ? 'healthy' : 'error';
                const healthScore = deploymentData.total_checks > 0 
                    ? Math.round((deploymentData.passed / deploymentData.total_checks) * 100)
                    : 0;
                
                updateStatusCard('deployment-status', status, {
                    'last-deploy': formatAge(deploymentData.timestamp),
                    'current-version': versionData.latest_release?.version || '--',
                    'health-score': `${healthScore}%`
                });
            } else {
                updateStatusCard('deployment-status', 'warning', {
                    'last-deploy': 'Unknown',
                    'current-version': '--',
                    'health-score': '--'
                });
            }
        }
        
        async function updateDataStatus() {
            const versionData = await loadVersionData();
            
            if (versionData) {
                const versionAge = formatAge(versionData.last_updated);
                const statsAge = formatAge(versionData.game_stats?.last_calculated);
                
                // Determine status based on data age
                const ageHours = (new Date() - new Date(versionData.last_updated)) / 1000 / 60 / 60;
                const status = ageHours > 24 ? 'warning' : 'healthy';
                
                updateStatusCard('data-status', status, {
                    'version-age': versionAge,
                    'stats-age': statsAge || versionAge,
                    'next-update': 'Within 6h'
                });
            } else {
                updateStatusCard('data-status', 'error', {
                    'version-age': 'No data',
                    'stats-age': 'No data',
                    'next-update': '--'
                });
            }
        }
        
        async function updateGitHubStatus() {
            const versionData = await loadVersionData();
            
            if (versionData && versionData.repository_stats) {
                const stats = versionData.repository_stats;
                const releaseAge = formatAge(versionData.latest_release?.published_at);
                
                updateStatusCard('github-status', 'healthy', {
                    'github-api': 'Connected',
                    'open-issues': stats.open_issues || '--',
                    'last-release': releaseAge
                });
            } else {
                updateStatusCard('github-status', 'error', {
                    'github-api': 'Disconnected',
                    'open-issues': '--',
                    'last-release': '--'
                });
            }
        }
        
        async function updateRecentChecks() {
            const healthData = await loadHealthData();
            const container = document.getElementById('recent-checks-list');

            if (healthData && healthData.results) {
                const recentChecks = healthData.results.slice(-10).reverse();

                container.innerHTML = recentChecks.map(check => {
                    const statusClass = check.passed ? 'pass' : (check.is_warning ? 'warn' : 'fail');
                    const statusText = check.passed ? 'PASS' : (check.is_warning ? 'WARN' : 'FAIL');

                    return `
                        <div class="check-item">
                            <span class="check-name">${check.test}</span>
                            <span class="check-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="check-item"><span class="check-name">No health check data available</span></div>';
            }
        }

        async function loadAutomationStatus() {
            try {
                const response = await fetch('/monitoring/data/automation-status.json', { cache: 'no-store' });
                const data = await response.json();
                return data;
            } catch (error) {
                console.warn('Could not load automation status:', error);
                return null;
            }
        }

        async function updateAutomationStatus() {
            const automationData = await loadAutomationStatus();
            const container = document.getElementById('automation-status');

            if (automationData && automationData.jobs) {
                const jobs = Object.entries(automationData.jobs);

                container.innerHTML = jobs.map(([jobName, job]) => {
                    const successRate = job.total_runs > 0
                        ? Math.round((job.success_count / job.total_runs) * 100)
                        : 0;

                    const statusClass = successRate >= 80 ? 'pass' : (successRate >= 50 ? 'warn' : 'fail');

                    return `
                        <div class="check-item">
                            <div>
                                <div class="check-name">${jobName.replace(/-/g, ' ')}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    Last run: ${formatAge(job.last_run)} |
                                    Success rate: ${successRate}% (${job.success_count}/${job.total_runs})
                                </div>
                            </div>
                            <span class="check-status ${statusClass}">
                                ${job.last_success && job.last_success > (job.last_failure || '') ? 'OK' : 'ISSUE'}
                            </span>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="check-item">
                        <span class="check-name">No automation runs logged yet</span>
                        <span class="check-status warn">PENDING</span>
                    </div>
                    <p style="color: var(--text-muted); margin-top: 1rem; font-size: 0.9rem;">
                        Automation jobs will appear here once GitHub Actions workflows start running.
                        Scheduled jobs: auto-update-data (every 6h), sync-leaderboards (daily), weekly-league-rollover (Sundays)
                    </p>
                `;
            }
        }

        async function updateLeagueStatus() {
            try {
                const response = await fetch('/leaderboard/data/weekly/current.json', { cache: 'no-store' });
                const league = await response.json();
                const container = document.getElementById('league-status');

                const weekInfo = league.week_info || {};
                const daysRemaining = weekInfo.days_remaining || 0;
                const statusClass = daysRemaining > 2 ? 'pass' : (daysRemaining > 0 ? 'warn' : 'fail');

                container.innerHTML = `
                    <div class="check-item">
                        <div>
                            <div class="check-name">Current Week: ${weekInfo.week_id || 'Unknown'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                ${weekInfo.start_date} to ${weekInfo.end_date}
                            </div>
                        </div>
                        <span class="check-status ${statusClass}">
                            ${daysRemaining} days left
                        </span>
                    </div>
                    <div class="check-item">
                        <span class="check-name">Weekly Seed</span>
                        <span style="font-family: monospace; color: var(--accent-primary);">
                            ${league.seed || 'Not generated'}
                        </span>
                    </div>
                    <div class="check-item">
                        <span class="check-name">Participants</span>
                        <span class="metric-value">
                            ${league.meta?.total_participants || 0}
                        </span>
                    </div>
                    <div class="check-item">
                        <span class="check-name">Submissions</span>
                        <span class="metric-value">
                            ${league.meta?.total_submissions || 0}
                        </span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('league-status').innerHTML = `
                    <div class="check-item">
                        <span class="check-name">Error loading league data</span>
                        <span class="check-status fail">ERROR</span>
                    </div>
                `;
            }
        }

        function triggerLeagueRollover() {
            if (!confirm('This will trigger a manual weekly league rollover. Are you sure?')) {
                return;
            }

            alert('Manual trigger feature requires GitHub Actions workflow_dispatch.\n\nTo manually rollover:\n1. Run: npm run league:archive\n2. Run: npm run league:new-week\n\nOr visit GitHub Actions and run "Weekly League Rollover" workflow.');
        }
        
        async function refreshData() {
            if (refreshing) return;
            
            refreshing = true;
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = 'Refreshing...';
            
            try {
                await Promise.all([
                    updateWebsiteStatus(),
                    updateDeploymentStatus(),
                    updateDataStatus(),
                    updateGitHubStatus(),
                    updateRecentChecks(),
                    updateAutomationStatus(),
                    updateLeagueStatus()
                ]);

                document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                refreshing = false;
                btn.disabled = false;
                btn.textContent = 'Refresh All Data';
            }
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', refreshData);
        
        // Auto-refresh every 2 minutes
        setInterval(refreshData, 2 * 60 * 1000);
    </script>
</body>
</html>