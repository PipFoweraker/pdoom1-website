<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P(DOOM) DASHBOARD ‚Äì AI Existential Risk Monitor</title>
	<!-- Plausible Analytics - Privacy-first, self-hosted analytics -->
	<script defer data-domain="pdoom1.com" src="https://analytics.pdoom1.com/js/script.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  * {margin:0;padding:0;box-sizing:border-box;}

  :root {
    --primary-green: #00ff41;
    --primary-cyan: #0ff;
    --primary-orange: #ff9966;
    --primary-red: #ff4444;
    --bg-dark: rgba(0,0,0,0.85);
    --bg-panel: rgba(0,20,10,0.75);
    --border-glow: rgba(0,255,65,0.3);
  }

  body {
    background:#000;
    color:#ffffff;
    font-family:'Courier New',Consolas,monospace;
    overflow:hidden;
  }

  canvas {position:absolute;top:0;left:0;z-index:1;}
  #container {position:relative;z-index:10;width:100vw;height:100vh;}

  /* Subtle scanline effect for retro terminal feel */
  #container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
      0deg,
      rgba(0, 255, 65, 0.03) 0px,
      rgba(0, 0, 0, 0.02) 1px,
      rgba(0, 0, 0, 0.02) 2px
    );
    pointer-events: none;
    z-index: 999;
    opacity: 0.3;
  }

  /* Header */
  #header {
    background:rgba(0,0,0,0.75);
    border-bottom:3px solid #00ff41;
    padding:15px 25px;
    display:flex;
    flex-direction:column;
    align-items:center;
    box-shadow:0 0 30px rgba(0,255,65,0.6);
    backdrop-filter:blur(5px);
  }

  #header h1 {
    font-size:30px;
    color:#ffffff;
    text-shadow:0 0 3px #000, 0 0 6px #000, 0 0 10px #00ff41;
    letter-spacing:3px;
    font-weight:bold;
  }

  #headerSubtitle {
    font-size:12px;
    color:#cccccc;
    margin-top:6px;
    text-shadow:0 0 2px #000;
  }

  #headerSubtitle a {
    color:#00ff41;
    text-decoration:none;
    text-shadow:0 0 8px #00ff41;
    margin:0 8px;
    transition:all 0.2s;
  }

  #headerSubtitle a:hover {
    color:#0ff;
    text-shadow:0 0 12px #0ff;
  }

  #headerMeta {
    display:flex;
    gap:20px;
    margin-top:8px;
    align-items:center;
  }

  #timestamp {
    font-size:13px;
    color:#cccccc;
    text-shadow:0 0 2px #000, 0 0 4px #000;
    font-weight:normal;
  }

  #status {
    font-size:13px;
    color:#ff9966;
    text-shadow:0 0 2px #000, 0 0 4px #000;
    font-weight:normal;
  }

  /* Warning Lights */
  #warningLights {
    position:fixed;
    top:80px;
    left:20px;
    z-index:250;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .warning-light {
    background:rgba(0,0,0,0.9);
    border:2px solid;
    border-radius:6px;
    padding:10px 15px;
    min-width:280px;
    box-shadow:0 0 20px;
    backdrop-filter:blur(8px);
    cursor:pointer;
    transition:all 0.3s ease;
  }

  .warning-light:hover {
    transform:scale(1.05);
  }

  .warning-light.critical {
    border-color:#ff4444;
    box-shadow:0 0 25px rgba(255,68,68,0.6);
    animation:criticalPulse 1.5s infinite;
  }

  .warning-light.warning {
    border-color:#ff6b35;
    box-shadow:0 0 20px rgba(255,107,53,0.5);
  }

  .warning-light.info {
    border-color:#0ff;
    box-shadow:0 0 15px rgba(0,255,255,0.4);
  }

  @keyframes criticalPulse {
    0%, 100% {opacity:1; box-shadow:0 0 25px rgba(255,68,68,0.6);}
    50% {opacity:0.85; box-shadow:0 0 40px rgba(255,68,68,0.9);}
  }

  .warning-title {
    font-size:11px;
    font-weight:bold;
    text-transform:uppercase;
    letter-spacing:1px;
    margin-bottom:4px;
    text-shadow:0 0 2px #000, 0 0 5px #000;
  }

  .warning-text {
    font-size:10px;
    opacity:0.9;
    text-shadow:0 0 2px #000;
  }

  /* Controls */
  #controls {
    position:fixed;
    top:80px;
    right:20px;
    background:rgba(0,0,0,0.85);
    border:3px solid #00ff41;
    border-radius:8px;
    padding:15px;
    z-index:200;
    box-shadow:0 0 30px rgba(0,255,65,0.5);
    min-width:340px;
    backdrop-filter:blur(10px);
    cursor:move;
  }

  .control-title {
    font-size:15px;
    color:#ffffff;
    text-align:center;
    margin-bottom:12px;
    text-shadow:0 0 3px #000, 0 0 8px #000, 0 0 12px #00ff41;
    font-weight:bold;
    border-bottom:2px solid #00ff41;
    padding-bottom:8px;
  }

  .slider-group {
    margin:14px 0;
    padding:10px;
    background:rgba(0,40,20,0.6);
    border-radius:5px;
  }

  .slider-label {
    font-size:12px;
    color:#ffffff;
    margin-bottom:6px;
    display:flex;
    justify-content:space-between;
    font-weight:bold;
    text-shadow:0 0 2px #000, 0 0 5px #000;
  }

  .slider-value {
    color:#00ff41;
    text-shadow:0 0 2px #000, 0 0 5px #000, 0 0 10px #00ff41;
    font-weight:bold;
  }

  input[type="range"] {
    width:100%;
    height:10px;
    background:linear-gradient(to right, #00ff41 0%, #ff6b35 50%, #f00 100%);
    border-radius:5px;
    outline:none;
  }

  input[type="range"]::-webkit-slider-thumb {
    appearance:none;
    width:22px;
    height:22px;
    background:#00ff41;
    cursor:pointer;
    border-radius:50%;
    box-shadow:0 0 20px #00ff41;
    border:2px solid #000;
  }

  /* Grid */
  #mainGrid {
    display:grid;
    grid-template-columns: 340px 1fr 340px;
    grid-template-rows: auto 1fr;
    gap:15px;
    height:calc(100vh - 75px);
    padding:15px;
  }

  /* Center column - split into 3 parts */
  #centerColumn {
    grid-column:2;
    grid-row:2;
    display:grid;
    grid-template-rows: 2fr 1fr;
    gap:15px;
  }

  /* Main graph - top 2/3 */
  #graphContainer {
    background:rgba(0,0,0,0.3);
    border:3px solid #00ff41;
    border-radius:8px;
    padding:20px;
    box-shadow:0 0 40px rgba(0,255,65,0.3);
    backdrop-filter:blur(3px);
  }

  /* Bottom row - split in half */
  #bottomRow {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:15px;
  }

  /* World map - bottom left */
  #pieContainer {
    background:rgba(0,0,0,0.5);
    border:3px solid #00ff41;
    border-radius:8px;
    padding:15px;
    box-shadow:0 0 30px rgba(0,255,65,0.3);
    backdrop-filter:blur(5px);
    position:relative;
  }

  #worldMap {
    width:100%;
    height:100%;
  }

  .map-region {
    fill:#00ff4133;
    stroke:#00ff41;
    stroke-width:1;
    cursor:pointer;
    transition:all 0.2s;
  }

  .map-region:hover {
    fill:#00ff4166;
    stroke:#0ff;
    stroke-width:2;
  }

  .map-region.selected {
    fill:#ff6b3566;
    stroke:#ff6b35;
    stroke-width:2;
  }

  #mapTitle {
    position:absolute;
    top:15px;
    left:15px;
    font-size:14px;
    color:#ffffff;
    font-weight:bold;
    text-shadow:0 0 10px #00ff41;
    pointer-events:none;
  }

  /* Text box - bottom right */
  #narrativeBox {
    background:rgba(0,0,0,0.7);
    border:3px solid #00ff41;
    border-radius:8px;
    padding:20px;
    box-shadow:0 0 30px rgba(0,255,65,0.3);
    backdrop-filter:blur(8px);
    overflow-y:auto;
    color:#ffffff;
    line-height:1.6;
  }

  .narrative-title {
    font-size:16px;
    color:#00ff41;
    margin-bottom:10px;
    font-weight:bold;
    text-shadow:0 0 10px #00ff41;
  }

  .narrative-text {
    font-size:12px;
    margin-bottom:12px;
    text-shadow:0 0 2px #000;
  }

  .highlight {
    color:#ff6b35;
    font-weight:bold;
    text-shadow:0 0 10px #ff6b35;
  }

  .source-link {
    color:#0ff;
    text-decoration:underline;
    cursor:pointer;
    text-shadow:0 0 8px #0ff;
  }

  .source-link:hover {
    color:#00ff41;
    text-shadow:0 0 12px #00ff41;
  }

  /* Panels */
  .panel {
    background:rgba(0,0,0,0.7);
    border:3px solid #00ff41;
    border-radius:8px;
    padding:15px;
    overflow-y:auto;
    box-shadow:0 0 25px rgba(0,255,65,0.3);
    backdrop-filter:blur(8px);
    cursor:move;
  }

  #leftPanel {grid-column:1;grid-row:2;}
  #rightPanel {grid-column:3;grid-row:2;}

  .panel-title {
    font-size:16px;
    color:#ffffff;
    text-align:center;
    padding:10px;
    background:rgba(0,255,65,0.15);
    border:2px solid #00ff41;
    margin:-15px -15px 15px -15px;
    text-shadow:0 0 3px #000, 0 0 8px #000, 0 0 15px #00ff41;
    font-weight:bold;
    letter-spacing:2px;
  }

  /* Metrics */
  .metric-group {
    margin-bottom:18px;
    padding:12px;
    background:rgba(0,40,20,0.65);
    border-left:4px solid #00ff41;
    border-radius:4px;
  }

  .metric-label {
    font-size:11px;
    color:#cccccc;
    opacity:0.95;
    text-transform:uppercase;
    letter-spacing:1px;
    font-weight:bold;
    text-shadow:0 0 2px #000;
  }

  .metric-value {
    font-size:26px;
    color:#ffffff;
    text-shadow:0 0 2px #000, 0 0 4px #000, 0 0 8px #00ff41;
    margin-top:6px;
    font-weight:bold;
  }

  .metric-subtext {
    font-size:11px;
    color:#999999;
    opacity:0.9;
    margin-top:4px;
    text-shadow:0 0 1px #000;
  }

  .warning {
    color:#ff9966 !important;
    text-shadow:0 0 2px #000, 0 0 4px #000, 0 0 8px #ff9966 !important;
    border-left-color:#ff9966 !important;
  }

  .critical {
    color:#ff4444 !important;
    text-shadow:0 0 2px #000, 0 0 4px #000, 0 0 10px #ff4444 !important;
    animation:criticalBlink 2s infinite;
    border-left-color:#ff4444 !important;
  }

  @keyframes criticalBlink {
    0%, 50%, 100% {opacity:1;}
    25%, 75% {opacity:0.85;}
  }

  /* Stock ticker */
  .stock-ticker {
    margin:10px 0;
    padding:10px;
    background:rgba(0,30,15,0.7);
    border-left:3px solid #00ff41;
    border-radius:3px;
    cursor:pointer;
    transition:all 0.2s;
  }

  .stock-ticker:hover {
    background:rgba(0,40,20,0.8);
    border-left-width:5px;
  }

  .stock-name {
    font-size:11px;
    color:#ffffff;
    font-weight:bold;
    text-shadow:0 0 2px #000, 0 0 5px #000;
  }

  .stock-price {
    font-size:18px;
    color:#ffffff;
    float:right;
    font-weight:bold;
    text-shadow:0 0 2px #000, 0 0 5px #000, 0 0 12px #00ff41;
  }

  .stock-change {
    font-size:10px;
    color:#cccccc;
    opacity:0.85;
    margin-top:2px;
    text-shadow:0 0 2px #000;
  }

  /* Cat cam */
  #catCam {
    margin-top:18px;
    padding:12px;
    background:rgba(0,20,10,0.75);
    border:2px solid #00ff41;
    border-radius:6px;
  }

  #catCam img {
    width:100%;
    border-radius:6px;
    border:2px solid #00ff41;
    box-shadow:0 0 20px rgba(0,255,65,0.4);
  }

  #catStatus {
    text-align:center;
    font-size:11px;
    color:#ffffff;
    margin-top:8px;
    font-weight:bold;
    text-shadow:0 0 2px #000, 0 0 5px #000, 0 0 10px #00ff41;
  }

  /* Scrollbar */
  ::-webkit-scrollbar {width:10px;}
  ::-webkit-scrollbar-track {background:rgba(0,10,5,0.5);border-radius:5px;}
  ::-webkit-scrollbar-thumb {background:#00ff41;border-radius:5px;}
  ::-webkit-scrollbar-thumb:hover {background:#00ff41ee;box-shadow:0 0 10px #00ff41;}
</style>
</head>
<body>

<canvas id="shader"></canvas>

<div id="container">
  <div id="header">
    <h1>‚ö† P(DOOM) DASHBOARD ‚ö†</h1>
    <div id="headerSubtitle">
      <a href="https://github.com/PipFoweraker/pdoom1-data" target="_blank">pdoom1-data</a> |
      <a href="https://github.com/PipFoweraker/pdoom1-website" target="_blank">website repo</a> |
      <a href="/" target="_blank">pdoom1 home</a>
    </div>
    <div id="headerMeta">
      <div id="status">EXPONENTIAL ESCALATION</div>
      <div id="timestamp"></div>
    </div>
  </div>

  <!-- Warning Lights -->
  <div id="warningLights"></div>

  <!-- Controls -->
  <div id="controls">
    <div class="control-title">‚öô SIMULATION CONTROLS</div>

    <div class="slider-group">
      <div class="slider-label">
        <span>Year:</span>
        <span class="slider-value" id="yearValue">2025.8</span>
      </div>
      <input type="range" id="yearSlider" min="2020" max="2032" step="0.1" value="2025.8">
    </div>

    <div class="slider-group">
      <div class="slider-label">
        <span>P(doom):</span>
        <span class="slider-value" id="pdoomValue">12.1%</span>
      </div>
    </div>

    <div class="slider-group">
      <div class="slider-label">
        <span>AI Safety Investment:</span>
        <span class="slider-value" id="safetyValue">1.0√ó</span>
      </div>
      <input type="range" id="safetySlider" min="0.1" max="5" step="0.1" value="1.0">
    </div>

    <div class="slider-group">
      <div class="slider-label">
        <span>Int'l Coordination:</span>
        <span class="slider-value" id="coordValue">0.3√ó</span>
      </div>
      <input type="range" id="coordSlider" min="0" max="1" step="0.05" value="0.3">
    </div>

    <div class="slider-group">
      <div class="slider-label">
        <span>Regulatory Strength:</span>
        <span class="slider-value" id="regValue">0.2√ó</span>
      </div>
      <input type="range" id="regSlider" min="0" max="1" step="0.05" value="0.2">
    </div>

    <div style="margin-top:15px;padding:10px;background:rgba(0,40,20,0.6);border-radius:5px;">
      <div class="slider-label" style="margin-bottom:8px;">
        <span>Adjusted P(doom):</span>
        <span class="slider-value" id="adjustedPdoom">12.1%</span>
      </div>
    </div>
  </div>

  <div id="mainGrid">
    <!-- Left Panel -->
    <div id="leftPanel" class="panel">
      <div class="panel-title">CURRENT STATUS</div>

      <div class="metric-group warning">
        <div class="metric-label">P(doom) Base</div>
        <div class="metric-value warning" id="currentPdoom">12.1%</div>
        <div class="metric-subtext">Exponential trajectory</div>
      </div>

      <div class="metric-group">
        <div class="metric-label">Latest Model</div>
        <div class="metric-value">GPT-5</div>
        <div class="metric-subtext">
          <a href="https://openai.com" target="_blank" class="source-link">Aug 2025 ‚Ä¢ 5√ó10¬≤‚Å∂ FLOPS</a>
        </div>
      </div>

      <div class="metric-group warning">
        <div class="metric-label">Compute Doubling</div>
        <div class="metric-value warning">5.6 mo</div>
        <div class="metric-subtext">
          <a href="https://epochai.org" target="_blank" class="source-link">Epoch AI estimate</a>
        </div>
      </div>

      <div class="metric-group critical">
        <div class="metric-label">2027 Projection</div>
        <div class="metric-value critical" id="projection2027">36%</div>
        <div class="metric-subtext">Current trajectory</div>
      </div>

      <!-- AI Company Stocks -->
      <div style="margin-top:20px;">
        <div class="metric-label" style="margin-bottom:12px;">üíπ AI STOCKS</div>

        <div class="stock-ticker" onclick="window.open('https://finance.yahoo.com/quote/NVDA', '_blank')">
          <div class="stock-name">NVIDIA (NVDA)</div>
          <div class="stock-price">$201</div>
          <div class="stock-change">+34% YTD</div>
        </div>

        <div class="stock-ticker" onclick="window.open('https://finance.yahoo.com/quote/MSFT', '_blank')">
          <div class="stock-name">Microsoft (MSFT)</div>
          <div class="stock-price">$542</div>
          <div class="stock-change">+28% YTD</div>
        </div>

        <div class="stock-ticker" onclick="window.open('https://finance.yahoo.com/quote/GOOGL', '_blank')">
          <div class="stock-name">Alphabet (GOOGL)</div>
          <div class="stock-price">$165</div>
          <div class="stock-change">+32% YTD</div>
        </div>

        <div class="stock-ticker" onclick="window.open('https://finance.yahoo.com/quote/META', '_blank')">
          <div class="stock-name">Meta (META)</div>
          <div class="stock-price">$584</div>
          <div class="stock-change">+35% YTD</div>
        </div>
      </div>

      <!-- AI Safety Investment Graph -->
      <div style="margin-top:20px;padding:15px;background:rgba(0,40,20,0.5);border:2px solid #00ff41;border-radius:6px;">
        <div class="metric-label" style="text-align:center;margin-bottom:10px;">üí∞ AI SAFETY INVESTMENT</div>
        <div id="safetyInvestmentGraph" style="width:100%;height:180px;"></div>
      </div>
    </div>

    <!-- Center Column - 3-part layout -->
    <div id="centerColumn">
      <!-- Main Graph (top 2/3) -->
      <div id="graphContainer">
        <div id="graph" style="width:100%;height:100%;"></div>
      </div>

      <!-- Bottom Row (bottom 1/3) -->
      <div id="bottomRow">
        <!-- World Map (left half) -->
        <div id="pieContainer">
          <div id="mapTitle">AI Compute by Region</div>
          <svg id="worldMap" viewBox="0 0 1000 500">
            <!-- Simplified world map regions -->
            <g id="mapRegions">
              <!-- North America -->
              <path class="map-region" data-region="USA" d="M 100,100 L 280,100 L 280,220 L 100,220 Z" />
              <!-- Europe -->
              <path class="map-region" data-region="Europe" d="M 450,80 L 600,80 L 600,200 L 450,200 Z" />
              <!-- China -->
              <path class="map-region" data-region="China" d="M 700,120 L 850,120 L 850,240 L 700,240 Z" />
              <!-- Others (Australia/Rest) -->
              <path class="map-region" data-region="Others" d="M 750,320 L 900,320 L 900,420 L 750,420 Z" />
            </g>
            <!-- Labels -->
            <text x="190" y="165" fill="#ffffff" font-size="20" text-anchor="middle" font-weight="bold" style="pointer-events:none;text-shadow:0 0 5px #000">USA</text>
            <text x="525" y="145" fill="#ffffff" font-size="20" text-anchor="middle" font-weight="bold" style="pointer-events:none;text-shadow:0 0 5px #000">EUROPE</text>
            <text x="775" y="185" fill="#ffffff" font-size="20" text-anchor="middle" font-weight="bold" style="pointer-events:none;text-shadow:0 0 5px #000">CHINA</text>
            <text x="825" y="375" fill="#ffffff" font-size="18" text-anchor="middle" font-weight="bold" style="pointer-events:none;text-shadow:0 0 5px #000">OTHERS</text>
          </svg>
        </div>

        <!-- Narrative Box (right half) -->
        <div id="narrativeBox">
          <div class="narrative-title">Current Situation Analysis</div>
          <div class="narrative-text">
            As of <span class="highlight">October 2025</span>, AI training compute has scaled exponentially with a doubling time of just <span class="highlight">5.6 months</span> (<a href="https://epochai.org/blog/compute-trends" target="_blank" class="source-link">Epoch AI</a>). The latest frontier model, GPT-5, was trained at <span class="highlight">5√ó10¬≤‚Å∂ FLOPS</span> ‚Äî representing a 1592√ó increase over <a href="https://arxiv.org/abs/2005.14165" target="_blank" class="source-link">GPT-3</a> from 2020.
          </div>
          <div class="narrative-text">
            Expert consensus on P(doom) ranges from <span class="highlight">5% (median)</span> to over 95% for pessimists like <a href="https://en.wikipedia.org/wiki/Eliezer_Yudkowsky" target="_blank" class="source-link">Eliezer Yudkowsky</a>. The current trajectory suggests P(doom) could reach <span class="highlight">36% by 2027</span> if scaling continues unchecked (<a href="https://pauseai.info/pdoom" target="_blank" class="source-link">PauseAI compilation</a>).
          </div>
          <div class="narrative-text">
            Three major factors could reduce risk: increased AI safety research funding, international coordination on development pace, and stronger regulatory frameworks. Current levels remain <span class="highlight">insufficient</span> relative to the scale of the challenge (<a href="https://www.anthropic.com" target="_blank" class="source-link">Anthropic safety research</a>).
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel -->
    <div id="rightPanel" class="panel">
      <div class="panel-title">EXPERT CONSENSUS</div>

      <div class="metric-group critical" onclick="window.open('https://en.wikipedia.org/wiki/Eliezer_Yudkowsky', '_blank')" style="cursor:pointer;">
        <div class="metric-label">E. Yudkowsky</div>
        <div class="metric-value critical">>95%</div>
        <div class="metric-subtext">MIRI Founder</div>
      </div>

      <div class="metric-group warning" onclick="window.open('https://en.wikipedia.org/wiki/Yoshua_Bengio', '_blank')" style="cursor:pointer;">
        <div class="metric-label">Y. Bengio</div>
        <div class="metric-value warning">50%</div>
        <div class="metric-subtext">Nobel Laureate</div>
      </div>

      <div class="metric-group warning" onclick="window.open('https://www.anthropic.com/company', '_blank')" style="cursor:pointer;">
        <div class="metric-label">D. Amodei</div>
        <div class="metric-value warning">25%</div>
        <div class="metric-subtext">Anthropic CEO</div>
      </div>

      <div class="metric-group warning" onclick="window.open('https://en.wikipedia.org/wiki/Geoffrey_Hinton', '_blank')" style="cursor:pointer;">
        <div class="metric-label">G. Hinton</div>
        <div class="metric-value warning">10-20%</div>
        <div class="metric-subtext">Nobel Laureate</div>
      </div>

      <div class="metric-group" onclick="window.open('https://pauseai.info/pdoom', '_blank')" style="cursor:pointer;">
        <div class="metric-label">Survey Median</div>
        <div class="metric-value">5%</div>
        <div class="metric-subtext">1000+ researchers</div>
      </div>

      <!-- Manifold Markets -->
      <div style="margin-top:20px;">
        <div class="metric-label" style="margin-bottom:12px;">üìä PREDICTION MARKETS</div>
        <div id="manifoldMarkets">
          <div class="stock-ticker" style="cursor:pointer;">
            <div class="stock-name" style="font-size:10px;">Loading markets...</div>
          </div>
        </div>
      </div>

      <!-- Cat Cam -->
      <div id="catCam">
        <div class="metric-label" style="text-align:center;margin-bottom:10px;">üê± CAT CAM</div>
        <img id="catImage" src="/assets/pdoom1-office-cat-default.png" alt="Cat">
        <div id="catStatus">Status: Monitoring</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== Shader ========== */
const shaderCanvas = document.getElementById('shader');
const gl = shaderCanvas.getContext('webgl');

function resizeShader() {
  shaderCanvas.width = window.innerWidth;
  shaderCanvas.height = window.innerHeight;
  if(gl) gl.viewport(0, 0, shaderCanvas.width, shaderCanvas.height);
}
window.addEventListener('resize', resizeShader);
resizeShader();

const vsSource = `attribute vec2 pos; void main() {gl_Position = vec4(pos, 0.0, 1.0);}`;
const fsSource = `
precision highp float;
uniform vec2 resolution;
uniform float time;
uniform float pdoomLevel;

float hash(vec2 p) {
  p = fract(p * vec2(123.45, 678.90));
  p += dot(p, p + 34.56);
  return fract(p.x * p.y);
}

vec2 voronoi(vec2 p, float speed) {
  vec2 n = floor(p), f = fract(p);
  float minDist = 10.0;
  for(int j = -1; j <= 1; j++) {
    for(int i = -1; i <= 1; i++) {
      vec2 neighbor = vec2(float(i), float(j));
      vec2 point = hash(n + neighbor) * vec2(sin(time * speed), cos(time * speed + 3.14)) * 0.4;
      float dist = length(neighbor + point - f);
      minDist = min(minDist, dist);
    }
  }
  return vec2(minDist, 0);
}

float neuralConnections(vec2 p, float t, float chaos) {
  float speed = 0.5 + chaos * 2.0;
  vec2 vor = voronoi(p * (3.5 + chaos), speed);
  float neuron = smoothstep(0.18, 0.12, vor.x) * (0.3 + 0.3 * sin(t * (4.0 + chaos * 6.0)));
  vec2 grid = fract(p * (6.0 + chaos * 3.0)) - 0.5;
  float axonH = smoothstep(0.008, 0.0, abs(grid.y + sin(p.x * 3.0 + t * (1.0 + chaos * 2.0)) * 0.3)) * (0.25 + chaos * 0.3);
  float axonV = smoothstep(0.008, 0.0, abs(grid.x + sin(p.y * 3.0 + t * (1.0 + chaos * 2.0)) * 0.3)) * (0.25 + chaos * 0.3);
  return neuron * (1.2 + chaos * 0.5) + axonH + axonV;
}

void main() {
  vec2 uv = gl_FragCoord.xy / resolution;
  vec2 p = uv * 2.0 - 1.0;
  p.x *= resolution.x / resolution.y;
  float chaos = pdoomLevel * 2.0;
  float t = time * (0.5 + chaos * 0.5);
  float neural = neuralConnections(p, t, chaos);

  vec3 safeColor = vec3(0.0, 1.0, 0.25);
  vec3 warnColor = vec3(1.0, 0.42, 0.21);
  vec3 criticalColor = vec3(1.0, 0.0, 0.0);
  vec3 baseColor = pdoomLevel < 0.3 ? mix(safeColor, warnColor, pdoomLevel / 0.3) : mix(warnColor, criticalColor, (pdoomLevel - 0.3) / 0.7);

  vec3 color = mix(baseColor * 0.10, baseColor * 0.4, neural * 0.6);
  color = mix(color, baseColor, neural * neural * 0.4);
  color *= neural * (0.3 + pdoomLevel * 0.2);
  color *= smoothstep(1.5, 0.3, length(p));
  color *= 0.45;  // Reduced for calmer appearance

  if(pdoomLevel > 0.5) {
    float pulse = 0.5 + 0.5 * sin(t * (5.0 + chaos * 3.0));
    color += criticalColor * pulse * (pdoomLevel - 0.5) * 0.15;
  }

  gl_FragColor = vec4(color, 1.0);
}
`;

function compileShader(source, type) {
  const shader = gl.createShader(type);
  gl.shaderSource(shader, source);
  gl.compileShader(shader);
  return shader;
}

const vs = compileShader(vsSource, gl.VERTEX_SHADER);
const fs = compileShader(fsSource, gl.FRAGMENT_SHADER);
const program = gl.createProgram();
gl.attachShader(program, vs);
gl.attachShader(program, fs);
gl.linkProgram(program);
gl.useProgram(program);

const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
const buffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);

const posLoc = gl.getAttribLocation(program, 'pos');
gl.enableVertexAttribArray(posLoc);
gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

const resolutionLoc = gl.getUniformLocation(program, 'resolution');
const timeLoc = gl.getUniformLocation(program, 'time');
const pdoomLevelLoc = gl.getUniformLocation(program, 'pdoomLevel');

let startTime = Date.now();
let currentPdoomLevel = 0.121;

function animateShader() {
  const time = (Date.now() - startTime) * 0.001;
  gl.uniform2f(resolutionLoc, shaderCanvas.width, shaderCanvas.height);
  gl.uniform1f(timeLoc, time);
  gl.uniform1f(pdoomLevelLoc, currentPdoomLevel);
  gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
  requestAnimationFrame(animateShader);
}
animateShader();

/* ========== Data & Functions ========== */
function pdoomFunc(year) {
  if(year < 2020) return 0.01;
  return Math.min(0.02 * Math.exp(0.4 * (year - 2020)), 1.0);
}

const computeData = [
  {year: 2018.5, model: 'GPT-1', compute: 1e21},
  {year: 2019.17, model: 'GPT-2', compute: 2.8e22},
  {year: 2020.5, model: 'GPT-3', compute: 3.14e23},
  {year: 2023.25, model: 'GPT-4', compute: 2.15e25},
  {year: 2025.67, model: 'GPT-5', compute: 5e26}
];

let safety = 1.0, coord = 0.3, reg = 0.2;

function adjustedPdoomFunc(year, s, c, r) {
  const base = pdoomFunc(year);
  const reduction = (s - 1) * 0.15 + c * 0.25 + r * 0.3;
  return Math.max(base * (1 - reduction), 0.001);
}

// Warning light milestones
const milestones = [
  {year: 2023.25, title: '‚ö† GPT-4 RELEASED', text: 'First 10¬≤‚Åµ FLOPS model deployed', type: 'warning', link: 'https://openai.com/research/gpt-4'},
  {year: 2025.67, title: '‚ö† GPT-5 RELEASED', text: '10¬≤‚Å∂ FLOPS threshold crossed', type: 'warning', link: 'https://openai.com'},
  {year: 2024.5, title: '‚ö† P(DOOM) >10%', text: 'Double-digit existential risk', type: 'warning'},
  {year: 2026.8, title: '‚ö† P(DOOM) >25%', text: 'Quarter probability threshold', type: 'critical'},
  {year: 2027.5, title: '‚ö† P(DOOM) >36%', text: 'Over one-third probability', type: 'critical'}
];

function updateWarningLights(currentYear) {
  const container = document.getElementById('warningLights');
  container.innerHTML = '';

  milestones.forEach(m => {
    if(Math.abs(currentYear - m.year) < 0.5) {
      const light = document.createElement('div');
      light.className = `warning-light ${m.type}`;
      if(m.link) {
        light.onclick = () => window.open(m.link, '_blank');
      }
      light.innerHTML = `
        <div class="warning-title">${m.title}</div>
        <div class="warning-text">${m.text}</div>
      `;
      container.appendChild(light);
    }
  });
}

function updateAll() {
  const year = parseFloat(document.getElementById('yearSlider').value);
  const pdoom = pdoomFunc(year);
  const adjusted = adjustedPdoomFunc(year, safety, coord, reg);

  document.getElementById('yearValue').textContent = year.toFixed(1);
  document.getElementById('pdoomValue').textContent = (pdoom * 100).toFixed(1) + '%';
  document.getElementById('currentPdoom').textContent = (pdoom * 100).toFixed(1) + '%';
  document.getElementById('adjustedPdoom').textContent = (adjusted * 100).toFixed(1) + '%';
  document.getElementById('projection2027').textContent = (pdoomFunc(2027) * 100).toFixed(0) + '%';

  currentPdoomLevel = pdoom;
  updateWarningLights(year);
  updatePlots(year);
}

function updatePlots(currentYear) {
  // Generate curves
  const pdoomCurve = [], adjustedCurve = [];
  for(let y = 2020; y <= 2031; y += 0.05) {
    const p = pdoomFunc(y);
    const adj = adjustedPdoomFunc(y, safety, coord, reg);
    pdoomCurve.push({year: y, pdoom: p});
    adjustedCurve.push({year: y, pdoom: adj});
    if(p >= 0.999) break;
  }

  // Main graph with dual Y-axes
  const layout = {
    xaxis: {
      title: {text: 'Year', font: {size: 14, color: '#ffffff'}},
      gridcolor: '#ffffff22',
      tickfont: {size: 12, color: '#ffffff'},
      range: [2020, 2031],
      nticks: 4  // Reduced from 6
    },
    yaxis: {
      title: {text: 'P(doom) %', font: {size: 14, color: '#ffffff'}},
      gridcolor: '#ffffff22',
      tickfont: {size: 12, color: '#ffffff'},
      range: [0, 105],
      ticksuffix: '%'
    },
    yaxis2: {
      title: {text: 'Training Compute (FLOPS)', font: {size: 12, color: '#cccccc'}},
      overlaying: 'y',
      side: 'right',
      type: 'log',
      tickfont: {size: 10, color: '#cccccc'},
      gridcolor: 'transparent'
    },
    plot_bgcolor: 'rgba(0,0,0,0)',
    paper_bgcolor: 'rgba(0,0,0,0)',
    font: {color: '#ffffff'},
    margin: {l: 60, r: 80, t: 20, b: 50},
    shapes: [{
      type: 'line',
      x0: currentYear, x1: currentYear,
      y0: 0, y1: 1,
      yref: 'paper',
      line: {color: '#0ff', width: 2, dash: 'dash'}
    }],
    annotations: [
      {
        x: currentYear, y: pdoomFunc(currentYear) * 100,
        text: '<b>NOW</b>',
        showarrow: true, arrowhead: 2, ax: 0, ay: -40,
        font: {size: 12, color: '#0ff'},
        bgcolor: 'rgba(0,0,0,0.9)',
        bordercolor: '#0ff',
        borderwidth: 2
      },
      ...computeData.map(d => ({
        x: d.year,
        y: pdoomFunc(d.year) * 100,
        text: `<b>${d.model}</b><br>${d.compute.toExponential(1)} FLOPS`,
        showarrow: true,
        arrowhead: 2,
        ax: 0,
        ay: -60,
        font: {size: 9, color: '#ffffff'},
        bgcolor: 'rgba(0,0,0,0.85)',
        bordercolor: '#00ff41',
        borderwidth: 1
      }))
    ]
  };

  Plotly.newPlot('graph', [
    {
      x: pdoomCurve.map(p => p.year),
      y: pdoomCurve.map(p => p.pdoom * 100),
      mode: 'lines',
      name: 'Base P(doom)',
      line: {color: '#ff6b35', width: 4},
      yaxis: 'y'
    },
    {
      x: adjustedCurve.map(p => p.year),
      y: adjustedCurve.map(p => p.pdoom * 100),
      mode: 'lines',
      name: 'Adjusted',
      line: {color: '#00ff41', width: 3, dash: 'dot'},
      yaxis: 'y'
    },
    {
      x: computeData.map(d => d.year),
      y: computeData.map(d => d.compute),
      mode: 'markers+lines',
      name: 'Training Compute',
      marker: {color: '#0ff', size: 10, symbol: 'diamond'},
      line: {color: '#0ff88', width: 2},
      yaxis: 'y2'
    }
  ], layout, {responsive: true, displayModeBar: false});

  // World map interaction
  const regionData = {
    'USA': { compute: 45, labs: ['OpenAI', 'Anthropic', 'Meta'], color: '#00ff41' },
    'China': { compute: 30, labs: ['Baidu', 'Alibaba', 'Tencent'], color: '#ff6b35' },
    'Europe': { compute: 15, labs: ['DeepMind', 'Mistral'], color: '#0ff' },
    'Others': { compute: 10, labs: ['Various'], color: '#f0f' }
  };

  document.querySelectorAll('.map-region').forEach(region => {
    region.addEventListener('click', function() {
      const regionName = this.getAttribute('data-region');
      const data = regionData[regionName];

      // Clear other selections
      document.querySelectorAll('.map-region').forEach(r => r.classList.remove('selected'));
      this.classList.add('selected');

      // Update map title with region info
      document.getElementById('mapTitle').innerHTML = `
        <b>${regionName}</b>: ${data.compute}% of AI compute<br>
        <span style="font-size:11px;opacity:0.8">Major labs: ${data.labs.join(', ')}</span>
      `;
    });
  });

  // AI Safety Investment Graph
  const safetyInvestmentData = [
    {year: 2018, investment: 50},
    {year: 2019, investment: 80},
    {year: 2020, investment: 150},
    {year: 2021, investment: 300},
    {year: 2022, investment: 500},
    {year: 2023, investment: 800},
    {year: 2024, investment: 1200},
    {year: 2025, investment: 1800}
  ];

  Plotly.newPlot('safetyInvestmentGraph', [{
    x: safetyInvestmentData.map(d => d.year),
    y: safetyInvestmentData.map(d => d.investment),
    mode: 'lines+markers',
    line: {color: '#00ff41', width: 3},
    marker: {color: '#00ff41', size: 8},
    hovertemplate: '<b>%{x}</b><br>$%{y}M invested<extra></extra>'
  }], {
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    font: {color: '#ffffff', size: 10},
    margin: {l: 45, r: 15, t: 10, b: 30},
    xaxis: {
      gridcolor: '#ffffff22',
      tickfont: {size: 10, color: '#ffffff'}
    },
    yaxis: {
      title: {text: '$M USD', font: {size: 10, color: '#ffffff'}},
      gridcolor: '#ffffff22',
      tickfont: {size: 10, color: '#ffffff'}
    }
  }, {responsive: true, displayModeBar: false});
}

/* ========== Event Handlers ========== */
document.getElementById('yearSlider').addEventListener('input', updateAll);
document.getElementById('safetySlider').addEventListener('input', (e) => {
  safety = parseFloat(e.target.value);
  document.getElementById('safetyValue').textContent = safety.toFixed(1) + '√ó';
  updateAll();
});
document.getElementById('coordSlider').addEventListener('input', (e) => {
  coord = parseFloat(e.target.value);
  document.getElementById('coordValue').textContent = coord.toFixed(1) + '√ó';
  updateAll();
});
document.getElementById('regSlider').addEventListener('input', (e) => {
  reg = parseFloat(e.target.value);
  document.getElementById('regValue').textContent = reg.toFixed(1) + '√ó';
  updateAll();
});

/* ========== Drag & Drop ========== */
function makeDraggable(element) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  element.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    element.style.top = (element.offsetTop - pos2) + "px";
    element.style.left = (element.offsetLeft - pos1) + "px";
    element.style.position = "fixed";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

makeDraggable(document.getElementById('controls'));
makeDraggable(document.getElementById('leftPanel'));
makeDraggable(document.getElementById('rightPanel'));

updateAll();

/* ========== Event Log Integration ========== */
async function loadEventLog() {
  try {
    const response = await fetch('/data/game-changes.json');
    const data = await response.json();

    // Get the 3 most recent entries
    const recentEvents = data.entries.slice(0, 3);

    // Update narrative box with event log
    const narrativeBox = document.getElementById('narrativeBox');
    let eventHTML = '<div class="narrative-title">Recent Development Log</div>';

    recentEvents.forEach(event => {
      eventHTML += `
        <div class="narrative-text">
          <span class="highlight">v${event.version}</span> (${event.date}): ${event.summary}
        </div>
      `;
    });

    // Add link to full changelog
    eventHTML += `
      <div class="narrative-text" style="margin-top:12px;">
        <a href="/game-changelog/" target="_blank" class="source-link">View Full Changelog ‚Üí</a>
      </div>
    `;

    narrativeBox.innerHTML = eventHTML;
  } catch (error) {
    console.error('Failed to load event log:', error);
  }
}

/* ========== Manifold Markets Integration ========== */
async function loadManifoldMarkets() {
  try {
    // Featured AI-related markets (can be updated with real slugs)
    const marketSlugs = [
      'will-an-ai-get-gold-on-any-internat',
      'will-ai-wipe-out-humanity-before-20'
    ];

    const container = document.getElementById('manifoldMarkets');
    container.innerHTML = '';

    // Fetch markets from Manifold API
    for (const slug of marketSlugs) {
      try {
        const response = await fetch(`https://api.manifold.markets/v0/slug/${slug}`);
        const market = await response.json();

        const probability = (market.probability * 100).toFixed(0);
        const marketDiv = document.createElement('div');
        marketDiv.className = 'stock-ticker';
        marketDiv.onclick = () => window.open(market.url, '_blank');
        marketDiv.innerHTML = `
          <div class="stock-name" style="font-size:10px;">${market.question.substring(0, 50)}...</div>
          <div class="stock-price" style="font-size:16px;">${probability}%</div>
          <div class="stock-change" style="font-size:9px;">Manifold Markets</div>
        `;
        container.appendChild(marketDiv);
      } catch (err) {
        console.error(`Failed to load market ${slug}:`, err);
      }
    }

    // Add fallback if no markets loaded
    if (container.children.length === 0) {
      container.innerHTML = `
        <div class="stock-ticker" onclick="window.open('https://manifold.markets/browse?topic=ai', '_blank')" style="cursor:pointer;">
          <div class="stock-name" style="font-size:10px;">Browse AI Markets</div>
          <div class="stock-price" style="font-size:14px;">‚Üí</div>
          <div class="stock-change" style="font-size:9px;">Manifold Markets</div>
        </div>
      `;
    }
  } catch (error) {
    console.error('Failed to load Manifold Markets:', error);
  }
}

/* ========== Timestamp & Cat ========== */
function updateTimestamp() {
  document.getElementById('timestamp').textContent = new Date().toISOString().slice(0, 19).replace('T', ' ') + ' UTC';
}
updateTimestamp();
setInterval(updateTimestamp, 1000);

// Load event log and markets on page load
loadEventLog();
loadManifoldMarkets();

const catImages = [
  '/assets/pdoom1-office-cat-default.png',
  '/assets/small-doom-cat.png'
];
let catIndex = 0;
setInterval(() => {
  catIndex = (catIndex + 1) % catImages.length;
  document.getElementById('catImage').src = catImages[catIndex];
  document.getElementById('catStatus').textContent = 'Status: ' + ['Observing...', 'Concerned', 'Monitoring'][Math.floor(Math.random() * 3)];
}, 8000);
</script>
</body>
</html>
