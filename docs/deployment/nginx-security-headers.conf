# Nginx Security Headers Configuration
# For pdoom1 Production API (api.pdoom1.com)
# Last Updated: 2025-11-10
#
# Installation:
# 1. SSH into production server: ssh ubuntu@208.113.200.215
# 2. sudo nano /etc/nginx/sites-available/api.pdoom1.com
# 3. Add these headers to the server block
# 4. sudo nginx -t  # Test configuration
# 5. sudo systemctl reload nginx

# ============================================================================
# HTTP Strict Transport Security (HSTS)
# ============================================================================
# Enforces HTTPS for 1 year, including all subdomains
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# ============================================================================
# Content Security Policy (CSP)
# ============================================================================
# Restricts resource loading to prevent XSS attacks
# Adjust 'unsafe-inline' as needed based on frontend requirements
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://pdoom1.com https://www.pdoom1.com; frame-ancestors 'none';" always;

# ============================================================================
# X-Frame-Options
# ============================================================================
# Prevents clickjacking attacks by disallowing embedding in iframes
add_header X-Frame-Options "SAMEORIGIN" always;

# ============================================================================
# X-Content-Type-Options
# ============================================================================
# Prevents MIME-sniffing attacks
add_header X-Content-Type-Options "nosniff" always;

# ============================================================================
# Referrer Policy
# ============================================================================
# Controls how much referrer information is sent with requests
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# ============================================================================
# Permissions Policy (formerly Feature-Policy)
# ============================================================================
# Restricts browser features (camera, microphone, geolocation, etc.)
add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

# ============================================================================
# X-XSS-Protection (Legacy, but still useful for older browsers)
# ============================================================================
add_header X-XSS-Protection "1; mode=block" always;

# ============================================================================
# Rate Limiting Configuration
# ============================================================================
# Add to http block in /etc/nginx/nginx.conf or main config

# General API rate limit: 60 requests per minute per IP
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=60r/m;

# Stricter limit for auth endpoints: 10 requests per minute per IP
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/m;

# Score submission limit: 30 requests per minute per IP
limit_req_zone $binary_remote_addr zone=score_limit:10m rate=30r/m;

# ============================================================================
# Apply Rate Limits in Location Blocks
# ============================================================================

# Example for auth endpoints:
# location /api/auth/ {
#     limit_req zone=auth_limit burst=5 nodelay;
#     proxy_pass http://localhost:8080;
#     ... other proxy settings ...
# }

# Example for score submission:
# location /api/scores/ {
#     limit_req zone=score_limit burst=10 nodelay;
#     proxy_pass http://localhost:8080;
#     ... other proxy settings ...
# }

# Example for general API:
# location /api/ {
#     limit_req zone=api_limit burst=15 nodelay;
#     proxy_pass http://localhost:8080;
#     ... other proxy settings ...
# }

# ============================================================================
# Additional Security Settings
# ============================================================================

# Hide nginx version in error pages and headers
server_tokens off;

# Set maximum request body size (prevents large file upload DoS)
client_max_body_size 1M;

# Set timeout for client connections
client_body_timeout 12s;
client_header_timeout 12s;
send_timeout 10s;

# Buffer size limits
client_body_buffer_size 128K;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;

# ============================================================================
# Complete Server Block Example
# ============================================================================

# server {
#     listen 443 ssl http2;
#     server_name api.pdoom1.com;
#
#     # SSL Configuration (Let's Encrypt)
#     ssl_certificate /etc/letsencrypt/live/api.pdoom1.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.pdoom1.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
#     ssl_prefer_server_ciphers on;
#
#     # Security Headers (from above)
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#
#     # Hide nginx version
#     server_tokens off;
#
#     # Rate limiting
#     limit_req zone=api_limit burst=15 nodelay;
#
#     # Proxy to Python API server
#     location / {
#         proxy_pass http://localhost:8080;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#
#     # Stricter rate limiting for auth endpoints
#     location /api/auth/ {
#         limit_req zone=auth_limit burst=5 nodelay;
#         proxy_pass http://localhost:8080;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#
#     # Health check endpoint (no rate limiting)
#     location /api/health {
#         proxy_pass http://localhost:8080;
#         proxy_set_header Host $host;
#         access_log off;  # Don't log health checks
#     }
# }
#
# # Redirect HTTP to HTTPS
# server {
#     listen 80;
#     server_name api.pdoom1.com;
#     return 301 https://$server_name$request_uri;
# }

# ============================================================================
# Testing Security Headers
# ============================================================================
#
# After deploying, test your security headers:
#
# 1. curl -I https://api.pdoom1.com
# 2. https://securityheaders.com/?q=api.pdoom1.com
# 3. https://www.ssllabs.com/ssltest/analyze.html?d=api.pdoom1.com
#
# ============================================================================
